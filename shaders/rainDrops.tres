[gd_resource type="VisualShader" load_steps=52 format=3 uid="uid://xrtipw2almnv"]

[ext_resource type="Texture2D" uid="uid://bop17867usfya" path="res://shaders/textures/rain_drops.tga" id="1_x2rej"]

[sub_resource type="VisualShaderNodeVectorOp" id="VisualShaderNodeVectorOp_x2rej"]
default_input_values = [0, Vector2(0, 0), 1, Vector2(2, 2)]
linked_parent_graph_frame = 15
op_type = 0
operator = 2

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_l3vrx"]
linked_parent_graph_frame = 16
constant = 2.0

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_26cv1"]
linked_parent_graph_frame = 16
op_type = 0

[sub_resource type="VisualShaderNodeFrame" id="VisualShaderNodeFrame_6lagv"]
size = Vector2(3416, 1223)
title = "Normal Extraction"
tint_color_enabled = true
tint_color = Color(0.17578125, 0.17578125, 0.17578125, 0.75)
attached_nodes = PackedInt32Array(48, 9, 12, 16, 17, 49, 71, 72, 76)

[sub_resource type="VisualShaderNodeFrame" id="VisualShaderNodeFrame_ph7u5"]
linked_parent_graph_frame = 15
size = Vector2(1596, 303)
title = "Helper_F"
attached_nodes = PackedInt32Array(14, 13, 18, 19)

[sub_resource type="VisualShaderNodeVectorOp" id="VisualShaderNodeVectorOp_t77vl"]
default_input_values = [0, Vector2(0, 0), 1, Vector2(1, 1)]
expanded_output_ports = [0]
linked_parent_graph_frame = 15
op_type = 0
operator = 1

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_ln83t"]
linked_parent_graph_frame = 16
constant = 1.0

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_4rsp0"]
linked_parent_graph_frame = 16
op_type = 0

[sub_resource type="VisualShaderNodeTexture" id="VisualShaderNodeTexture_6lagv"]
expanded_output_ports = [0]
texture = ExtResource("1_x2rej")

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_wcvx0"]
expanded_output_ports = [0]

[sub_resource type="VisualShaderNodeColorConstant" id="VisualShaderNodeColorConstant_p33wp"]
constant = Color(0, 0, 0, 1)

[sub_resource type="VisualShaderNodeInput" id="VisualShaderNodeInput_ph7u5"]
input_name = "uv"

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_x2rej"]
constant = 0.5

[sub_resource type="VisualShaderNodeInput" id="VisualShaderNodeInput_t77vl"]
linked_parent_graph_frame = 47
input_name = "time"

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_vaojw"]
linked_parent_graph_frame = 47
operator = 2

[sub_resource type="VisualShaderNodeUVFunc" id="VisualShaderNodeUVFunc_t77vl"]
function = 1

[sub_resource type="VisualShaderNodeFloatParameter" id="VisualShaderNodeFloatParameter_ln83t"]
linked_parent_graph_frame = 47
parameter_name = "RainSpeed"
default_value_enabled = true
default_value = 0.5

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_4rsp0"]
linked_parent_graph_frame = 47
operator = 1

[sub_resource type="VisualShaderNodeFloatFunc" id="VisualShaderNodeFloatFunc_yv4yx"]
linked_parent_graph_frame = 47
function = 17

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_wcvx0"]
default_input_values = [0, 0.0, 1, 2.0]
linked_parent_graph_frame = 47
operator = 2

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_x2rej"]
default_input_values = [0, 0.0, 1, 1.0]
linked_parent_graph_frame = 47
operator = 1

[sub_resource type="VisualShaderNodeFloatFunc" id="VisualShaderNodeFloatFunc_l3vrx"]
linked_parent_graph_frame = 47
function = 18

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_26cv1"]
linked_parent_graph_frame = 47
operator = 2

[sub_resource type="VisualShaderNodeFrame" id="VisualShaderNodeFrame_t77vl"]
size = Vector2(4356, 1243)
title = "Temporal Function"
attached_nodes = PackedInt32Array(44, 46, 45, 43, 40, 42, 41, 39, 38, 55, 56, 69, 62, 68)

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_l3vrx"]
default_input_values = [0, 0.0, 1, -1.0]
linked_parent_graph_frame = 15
operator = 2

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_6lagv"]
default_input_values = [0, 0.0, 1, -1.0]
linked_parent_graph_frame = 15
operator = 2

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_p33wp"]
linked_parent_graph_frame = 47
operator = 2

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_3riwy"]
linked_parent_graph_frame = 47
constant = -1.0

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_vaojw"]
constant = 3.0

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_5rf4a"]
linked_parent_graph_frame = 47

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_ph7u5"]
default_input_values = [0, 0.0, 1, 2.06]
linked_parent_graph_frame = 47
operator = 5

[sub_resource type="VisualShaderNodeFloatFunc" id="VisualShaderNodeFloatFunc_t77vl"]
linked_parent_graph_frame = 47
function = 18

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_ln83t"]
op_type = 0

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_4rsp0"]
constant = 1.0

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_t77vl"]
default_input_values = [0, 0.0, 1, -1.0]
linked_parent_graph_frame = 15
operator = 2

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_ln83t"]
default_input_values = [0, 0.0, 1, -1.0]
linked_parent_graph_frame = 15
operator = 2

[sub_resource type="VisualShaderNodeFloatOp" id="VisualShaderNodeFloatOp_yv4yx"]
default_input_values = [0, 0.0, 1, 0.1]
operator = 5

[sub_resource type="VisualShaderNodeFloatFunc" id="VisualShaderNodeFloatFunc_wcvx0"]
function = 31

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_p33wp"]
linked_parent_graph_frame = 15
constant = -1.0

[sub_resource type="VisualShaderNodeExpression" id="VisualShaderNodeExpression_x2rej"]
size = Vector2(2080, 2200)
expression = "// https://youtu.be/5eyq2FJ6lig?list=PL78XDi0TS4lHpIHseomZCPRm_NkyUMkPs  raindrops shader original by Ben Cloward
// Godot GLSL port Marko Fucek
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Animation (using blue channel)
float delay = 0.7; // Much longer pause (0-1)
float anim = fract(texture_data.b - time * rain_amount);
anim = anim * step(anim, 1.0 - delay);

float alpha_processed = texture_data.a * 2.0 - 1.0;
float rain_mask = clamp(alpha_processed, 0.0, 1.0);
float inverted_alpha = alpha_processed * -1.0; 

float falloff = clamp(pow(inverted_alpha, 2.9), 0.05, 1.0);

float rain_drop = anim * rain_mask;

// Combined intensity
float intensity = rain_drop + falloff;

// Flow direction from RG channels
vec2 flow_raw = texture_data.rg * 2.0 - 1.0;

float flow_x = flow_raw.x * intensity * -1.0;
float flow_y = flow_raw.y * intensity * -1.0;

float z_squared = 1.0 - (flow_x * flow_x + flow_y * flow_y);
float flow_z = sqrt(max(z_squared, 0.5)); // clamp to prevent sqrt of negative

// Create normal
vec3 normal = vec3(flow_x, flow_y, flow_z);


// Roughness calculation
float roughness = 1.0 - pow(intensity, 0.5);

// Outputs
ROUGHNESS = roughness;
NORMAL = normal;"

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_x2rej"]
op_type = 0

[sub_resource type="VisualShaderNodeFloatConstant" id="VisualShaderNodeFloatConstant_26cv1"]
constant = 5.0

[sub_resource type="VisualShaderNodeUVFunc" id="VisualShaderNodeUVFunc_6lagv"]
function = 1

[sub_resource type="VisualShaderNodeInput" id="VisualShaderNodeInput_vaojw"]
input_name = "uv"

[sub_resource type="VisualShaderNodeTexture" id="VisualShaderNodeTexture_ln83t"]
expanded_output_ports = [0]
texture = ExtResource("1_x2rej")

[sub_resource type="VisualShaderNodeFloatParameter" id="VisualShaderNodeFloatParameter_4rsp0"]
parameter_name = "RainSpeed2"
default_value_enabled = true
default_value = 1.0

[sub_resource type="VisualShaderNodeInput" id="VisualShaderNodeInput_yv4yx"]
input_name = "time"

[sub_resource type="VisualShaderNodeExpression" id="VisualShaderNodeExpression_wcvx0"]
size = Vector2(2180, 2260)
expression = "// Inputs: 
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Temporal animation using blue channel
float anim_time = time * rain_amount;
float animated_blue = fract(texture_data.b - anim_time);

// Rain drop mask/alpha processing
float alpha_mask = min(max(texture_data.a * 2.0 - 1.0, 0.0), 1.0);
float rain_drop = animated_blue * alpha_mask;

// Falloff from alpha channel
float inverted_alpha = (1.0 - texture_data.a * 2.0) * -1.0;
float falloff = min(max(pow(inverted_alpha, 2.06), 0.0), 1.0);

// Combined intensity
float intensity = rain_drop + falloff;

// Calculate flow vectors from RG channels (normalized to [-1, 1])
vec2 flow_direction = texture_data.rg * 2.0 - 1.0;

// Apply intensity to flow
vec2 distorted_flow = flow_direction * intensity;

// Calculate proper normal with correct Z (your improved approach)
float flow_magnitude_sq = dot(distorted_flow, distorted_flow);
float z_component = sqrt(max(1.0 - flow_magnitude_sq, 0.0));
vec3 normal = vec3(distorted_flow.x, distorted_flow.y, z_component);
normal = normalize(normal);

// Calculate roughness
float roughness = 1.0 - pow(intensity, 0.1);

// Outputs
ROUGHNESS = roughness;
NORMAL = normal;"

[sub_resource type="VisualShaderNodeExpression" id="VisualShaderNodeExpression_p33wp"]
size = Vector2(2180, 2260)
expression = "// Inputs: 
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Exact translation of your original code:

// Animation
float anim = fract(texture_data.b - time * rain_amount);

// Alpha processing
float alpha_processed = texture_data.a * 2.0 - 1.0;
float mask = min(max(alpha_processed, 0.0), 1.0);
float rain_drop = anim * mask;

// Falloff
float inverted_alpha = alpha_processed * -1.0;
float falloff = min(max(pow(inverted_alpha, 2.06), 0.0), 1.0);

// Intensity
float intensity = rain_drop + falloff;

// Flow direction (RG channels)
vec2 flow_direction = texture_data.rg * 2.0 - 1.0;

// Apply intensity and invert (your n_out76p0 = -1.0)
vec2 flow = flow_direction * intensity * -1.0;

// Your original normal (Z = 1.0, NOT normalized!)
vec3 normal = vec3(flow.x, flow.y, 1.0);

// Roughness
float roughness = 1.0 - pow(intensity, 0.1);

// Outputs (EXACTLY like your original)
ROUGHNESS = roughness;
NORMAL = normal; // Not normalized, Z=1.0
SPECULAR = 0.5; // Your n_out35p0
ALBEDO = vec3(0.070827); // Your n_out24p0"

[sub_resource type="VisualShaderNodeVectorCompose" id="VisualShaderNodeVectorCompose_yv4yx"]
expanded_output_ports = [0]
linked_parent_graph_frame = 15
op_type = 0

[resource]
code = "shader_type spatial;
render_mode blend_mix, depth_draw_opaque, depth_test_default, cull_back, diffuse_lambert, specular_schlick_ggx;

uniform sampler2D tex_frg_83;
uniform float RainSpeed2 = 1.0;



void fragment() {
// ColorConstant:24
	vec4 n_out24p0 = vec4(0.000000, 0.000000, 0.000000, 1.000000);


// Input:82
	vec2 n_out82p0 = UV;


// FloatConstant:80
	float n_out80p0 = 5.000000;


// VectorCompose:79
	vec2 n_out79p0 = vec2(n_out80p0, n_out80p0);


// UVFunc:81
	vec2 n_in81p2 = vec2(0.00000, 0.00000);
	vec2 n_out81p0 = (n_out82p0 - n_in81p2) * n_out79p0 + n_in81p2;


// Texture2D:83
	vec4 n_out83p0 = texture(tex_frg_83, n_out81p0);


// FloatParameter:84
	float n_out84p0 = RainSpeed2;


// Input:85
	float n_out85p0 = TIME;


	float n_out77p0;
	vec3 n_out77p1;
// Expression:77
	n_out77p0 = 0.0;
	n_out77p1 = vec3(0.0, 0.0, 0.0);
	{
		// https://youtu.be/5eyq2FJ6lig?list=PL78XDi0TS4lHpIHseomZCPRm_NkyUMkPs  raindrops shader original by Ben Cloward
		// Godot GLSL port Marko Fucek
		// n_out83p0 - vec4 (RGBA from texture sampled with UV * 3.0)
		// n_out84p0 - float
		// n_out85p0 - float
		
		// Animation (using blue channel)
		float delay = 0.7; // Much longer pause (0-1)
		float anim = fract(n_out83p0.b - n_out85p0 * n_out84p0);
		anim = anim * step(anim, 1.0 - delay);
		
		float alpha_processed = n_out83p0.a * 2.0 - 1.0;
		float rain_mask = clamp(alpha_processed, 0.0, 1.0);
		float inverted_alpha = alpha_processed * -1.0; 
		
		float falloff = clamp(pow(inverted_alpha, 2.9), 0.05, 1.0);
		
		float rain_drop = anim * rain_mask;
		
		// Combined intensity
		float intensity = rain_drop + falloff;
		
		// Flow direction from RG channels
		vec2 flow_raw = n_out83p0.rg * 2.0 - 1.0;
		
		float flow_x = flow_raw.x * intensity * -1.0;
		float flow_y = flow_raw.y * intensity * -1.0;
		
		float z_squared = 1.0 - (flow_x * flow_x + flow_y * flow_y);
		float flow_z = sqrt(max(z_squared, 0.5)); // clamp to prevent sqrt of negative
		
		// Create normal
		vec3 normal = vec3(flow_x, flow_y, flow_z);
		
		
		// Roughness calculation
		float roughness = 1.0 - pow(intensity, 0.5);
		
		// Outputs
		n_out77p0 = roughness;
		n_out77p1 = normal;
	}


// FloatConstant:35
	float n_out35p0 = 0.500000;


// Output:0
	ALBEDO = vec3(n_out24p0.xyz);
	ROUGHNESS = n_out77p0;
	SPECULAR = n_out35p0;
	NORMAL = n_out77p1;


}
"
nodes/vertex/0/position = Vector2(1620, 460)
nodes/fragment/0/position = Vector2(2580, 1340)
nodes/fragment/2/node = SubResource("VisualShaderNodeTexture_6lagv")
nodes/fragment/2/position = Vector2(-6660, -2240)
nodes/fragment/3/node = SubResource("VisualShaderNodeInput_ph7u5")
nodes/fragment/3/position = Vector2(-8400, -2300)
nodes/fragment/4/node = SubResource("VisualShaderNodeUVFunc_t77vl")
nodes/fragment/4/position = Vector2(-7300, -2160)
nodes/fragment/6/node = SubResource("VisualShaderNodeFloatConstant_vaojw")
nodes/fragment/6/position = Vector2(-8380, -1860)
nodes/fragment/7/node = SubResource("VisualShaderNodeVectorCompose_ln83t")
nodes/fragment/7/position = Vector2(-7780, -2020)
nodes/fragment/9/node = SubResource("VisualShaderNodeVectorCompose_yv4yx")
nodes/fragment/9/position = Vector2(-4920, -2380)
nodes/fragment/12/node = SubResource("VisualShaderNodeVectorOp_x2rej")
nodes/fragment/12/position = Vector2(-4440, -2400)
nodes/fragment/13/node = SubResource("VisualShaderNodeFloatConstant_l3vrx")
nodes/fragment/13/position = Vector2(-5260, -1640)
nodes/fragment/14/node = SubResource("VisualShaderNodeVectorCompose_26cv1")
nodes/fragment/14/position = Vector2(-4900, -1740)
nodes/fragment/15/node = SubResource("VisualShaderNodeFrame_6lagv")
nodes/fragment/15/position = Vector2(-5340, -2700)
nodes/fragment/16/node = SubResource("VisualShaderNodeFrame_ph7u5")
nodes/fragment/16/position = Vector2(-5300, -1820)
nodes/fragment/17/node = SubResource("VisualShaderNodeVectorOp_t77vl")
nodes/fragment/17/position = Vector2(-3520, -2500)
nodes/fragment/18/node = SubResource("VisualShaderNodeFloatConstant_ln83t")
nodes/fragment/18/position = Vector2(-4440, -1640)
nodes/fragment/19/node = SubResource("VisualShaderNodeVectorCompose_4rsp0")
nodes/fragment/19/position = Vector2(-4080, -1740)
nodes/fragment/22/node = SubResource("VisualShaderNodeVectorCompose_wcvx0")
nodes/fragment/22/position = Vector2(-1460, -1800)
nodes/fragment/24/node = SubResource("VisualShaderNodeColorConstant_p33wp")
nodes/fragment/24/position = Vector2(2040, 1000)
nodes/fragment/35/node = SubResource("VisualShaderNodeFloatConstant_x2rej")
nodes/fragment/35/position = Vector2(2040, 1200)
nodes/fragment/38/node = SubResource("VisualShaderNodeInput_t77vl")
nodes/fragment/38/position = Vector2(-7540, -560)
nodes/fragment/39/node = SubResource("VisualShaderNodeFloatOp_vaojw")
nodes/fragment/39/position = Vector2(-6940, -420)
nodes/fragment/40/node = SubResource("VisualShaderNodeFloatParameter_ln83t")
nodes/fragment/40/position = Vector2(-7560, -360)
nodes/fragment/41/node = SubResource("VisualShaderNodeFloatOp_4rsp0")
nodes/fragment/41/position = Vector2(-5280, -740)
nodes/fragment/42/node = SubResource("VisualShaderNodeFloatFunc_yv4yx")
nodes/fragment/42/position = Vector2(-4840, -680)
nodes/fragment/43/node = SubResource("VisualShaderNodeFloatOp_wcvx0")
nodes/fragment/43/position = Vector2(-6040, 60)
nodes/fragment/44/node = SubResource("VisualShaderNodeFloatOp_x2rej")
nodes/fragment/44/position = Vector2(-5580, 60)
nodes/fragment/45/node = SubResource("VisualShaderNodeFloatFunc_l3vrx")
nodes/fragment/45/position = Vector2(-4800, -360)
nodes/fragment/46/node = SubResource("VisualShaderNodeFloatOp_26cv1")
nodes/fragment/46/position = Vector2(-4360, -580)
nodes/fragment/47/node = SubResource("VisualShaderNodeFrame_t77vl")
nodes/fragment/47/position = Vector2(-1820, 1680)
nodes/fragment/48/node = SubResource("VisualShaderNodeFloatOp_l3vrx")
nodes/fragment/48/position = Vector2(-2720, -2620)
nodes/fragment/49/node = SubResource("VisualShaderNodeFloatOp_6lagv")
nodes/fragment/49/position = Vector2(-2760, -2140)
nodes/fragment/55/node = SubResource("VisualShaderNodeFloatOp_p33wp")
nodes/fragment/55/position = Vector2(-4700, 80)
nodes/fragment/56/node = SubResource("VisualShaderNodeFloatConstant_3riwy")
nodes/fragment/56/position = Vector2(-5100, 300)
nodes/fragment/62/node = SubResource("VisualShaderNodeFloatOp_5rf4a")
nodes/fragment/62/position = Vector2(-3620, -740)
nodes/fragment/68/node = SubResource("VisualShaderNodeFloatOp_ph7u5")
nodes/fragment/68/position = Vector2(-4180, 100)
nodes/fragment/69/node = SubResource("VisualShaderNodeFloatFunc_t77vl")
nodes/fragment/69/position = Vector2(-3740, 140)
nodes/fragment/70/node = SubResource("VisualShaderNodeFloatConstant_4rsp0")
nodes/fragment/70/position = Vector2(-1920, -1460)
nodes/fragment/71/node = SubResource("VisualShaderNodeFloatOp_t77vl")
nodes/fragment/71/position = Vector2(-2380, -2140)
nodes/fragment/72/node = SubResource("VisualShaderNodeFloatOp_ln83t")
nodes/fragment/72/position = Vector2(-2300, -2620)
nodes/fragment/74/node = SubResource("VisualShaderNodeFloatOp_yv4yx")
nodes/fragment/74/position = Vector2(-2880, -500)
nodes/fragment/75/node = SubResource("VisualShaderNodeFloatFunc_wcvx0")
nodes/fragment/75/position = Vector2(-2480, -420)
nodes/fragment/76/node = SubResource("VisualShaderNodeFloatConstant_p33wp")
nodes/fragment/76/position = Vector2(-2800, -1780)
nodes/fragment/77/node = SubResource("VisualShaderNodeExpression_x2rej")
nodes/fragment/77/position = Vector2(240, 1540)
nodes/fragment/77/size = Vector2(2080, 2200)
nodes/fragment/77/input_ports = "0,5,texture_data;1,0,rain_amount;2,0,time;"
nodes/fragment/77/output_ports = "0,0,ROUGHNESS;1,4,NORMAL;"
nodes/fragment/77/expression = "// https://youtu.be/5eyq2FJ6lig?list=PL78XDi0TS4lHpIHseomZCPRm_NkyUMkPs  raindrops shader original by Ben Cloward
// Godot GLSL port Marko Fucek
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Animation (using blue channel)
float delay = 0.7; // Much longer pause (0-1)
float anim = fract(texture_data.b - time * rain_amount);
anim = anim * step(anim, 1.0 - delay);

float alpha_processed = texture_data.a * 2.0 - 1.0;
float rain_mask = clamp(alpha_processed, 0.0, 1.0);
float inverted_alpha = alpha_processed * -1.0; 

float falloff = clamp(pow(inverted_alpha, 2.9), 0.05, 1.0);

float rain_drop = anim * rain_mask;

// Combined intensity
float intensity = rain_drop + falloff;

// Flow direction from RG channels
vec2 flow_raw = texture_data.rg * 2.0 - 1.0;

float flow_x = flow_raw.x * intensity * -1.0;
float flow_y = flow_raw.y * intensity * -1.0;

float z_squared = 1.0 - (flow_x * flow_x + flow_y * flow_y);
float flow_z = sqrt(max(z_squared, 0.5)); // clamp to prevent sqrt of negative

// Create normal
vec3 normal = vec3(flow_x, flow_y, flow_z);


// Roughness calculation
float roughness = 1.0 - pow(intensity, 0.5);

// Outputs
ROUGHNESS = roughness;
NORMAL = normal;"
nodes/fragment/79/node = SubResource("VisualShaderNodeVectorCompose_x2rej")
nodes/fragment/79/position = Vector2(-820, 1540)
nodes/fragment/80/node = SubResource("VisualShaderNodeFloatConstant_26cv1")
nodes/fragment/80/position = Vector2(-1300, 1560)
nodes/fragment/81/node = SubResource("VisualShaderNodeUVFunc_6lagv")
nodes/fragment/81/position = Vector2(-340, 1260)
nodes/fragment/82/node = SubResource("VisualShaderNodeInput_vaojw")
nodes/fragment/82/position = Vector2(-980, 1300)
nodes/fragment/83/node = SubResource("VisualShaderNodeTexture_ln83t")
nodes/fragment/83/position = Vector2(-320, 1680)
nodes/fragment/84/node = SubResource("VisualShaderNodeFloatParameter_4rsp0")
nodes/fragment/84/position = Vector2(-420, 2460)
nodes/fragment/85/node = SubResource("VisualShaderNodeInput_yv4yx")
nodes/fragment/85/position = Vector2(-440, 2940)
nodes/fragment/86/node = SubResource("VisualShaderNodeExpression_wcvx0")
nodes/fragment/86/position = Vector2(-120, 6900)
nodes/fragment/86/size = Vector2(2180, 2260)
nodes/fragment/86/input_ports = "0,5,texture_data;1,0,rain_amount;2,0,time;"
nodes/fragment/86/output_ports = "0,0,roughness;1,4,normal;"
nodes/fragment/86/expression = "// Inputs: 
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Temporal animation using blue channel
float anim_time = time * rain_amount;
float animated_blue = fract(texture_data.b - anim_time);

// Rain drop mask/alpha processing
float alpha_mask = min(max(texture_data.a * 2.0 - 1.0, 0.0), 1.0);
float rain_drop = animated_blue * alpha_mask;

// Falloff from alpha channel
float inverted_alpha = (1.0 - texture_data.a * 2.0) * -1.0;
float falloff = min(max(pow(inverted_alpha, 2.06), 0.0), 1.0);

// Combined intensity
float intensity = rain_drop + falloff;

// Calculate flow vectors from RG channels (normalized to [-1, 1])
vec2 flow_direction = texture_data.rg * 2.0 - 1.0;

// Apply intensity to flow
vec2 distorted_flow = flow_direction * intensity;

// Calculate proper normal with correct Z (your improved approach)
float flow_magnitude_sq = dot(distorted_flow, distorted_flow);
float z_component = sqrt(max(1.0 - flow_magnitude_sq, 0.0));
vec3 normal = vec3(distorted_flow.x, distorted_flow.y, z_component);
normal = normalize(normal);

// Calculate roughness
float roughness = 1.0 - pow(intensity, 0.1);

// Outputs
ROUGHNESS = roughness;
NORMAL = normal;"
nodes/fragment/87/node = SubResource("VisualShaderNodeExpression_p33wp")
nodes/fragment/87/position = Vector2(2120, 6880)
nodes/fragment/87/size = Vector2(2180, 2260)
nodes/fragment/87/input_ports = "0,5,texture_data;1,0,rain_amount;2,0,time;"
nodes/fragment/87/output_ports = "0,0,roughness;1,4,normal;"
nodes/fragment/87/expression = "// Inputs: 
// texture_data - vec4 (RGBA from texture sampled with UV * 3.0)
// rain_amount - float
// time - float

// Exact translation of your original code:

// Animation
float anim = fract(texture_data.b - time * rain_amount);

// Alpha processing
float alpha_processed = texture_data.a * 2.0 - 1.0;
float mask = min(max(alpha_processed, 0.0), 1.0);
float rain_drop = anim * mask;

// Falloff
float inverted_alpha = alpha_processed * -1.0;
float falloff = min(max(pow(inverted_alpha, 2.06), 0.0), 1.0);

// Intensity
float intensity = rain_drop + falloff;

// Flow direction (RG channels)
vec2 flow_direction = texture_data.rg * 2.0 - 1.0;

// Apply intensity and invert (your n_out76p0 = -1.0)
vec2 flow = flow_direction * intensity * -1.0;

// Your original normal (Z = 1.0, NOT normalized!)
vec3 normal = vec3(flow.x, flow.y, 1.0);

// Roughness
float roughness = 1.0 - pow(intensity, 0.1);

// Outputs (EXACTLY like your original)
ROUGHNESS = roughness;
NORMAL = normal; // Not normalized, Z=1.0
SPECULAR = 0.5; // Your n_out35p0
ALBEDO = vec3(0.070827); // Your n_out24p0"
nodes/fragment/connections = PackedInt32Array(6, 0, 7, 0, 6, 0, 7, 1, 7, 0, 4, 1, 4, 0, 2, 0, 9, 0, 12, 0, 13, 0, 14, 0, 13, 0, 14, 1, 12, 0, 17, 0, 18, 0, 19, 0, 18, 0, 19, 1, 3, 0, 4, 0, 14, 0, 12, 1, 19, 0, 17, 1, 35, 0, 0, 4, 38, 0, 39, 0, 40, 0, 39, 1, 39, 0, 41, 1, 41, 0, 42, 0, 43, 0, 44, 0, 44, 0, 45, 0, 42, 0, 46, 0, 45, 0, 46, 1, 17, 1, 48, 0, 17, 2, 49, 0, 2, 1, 9, 0, 2, 2, 9, 1, 2, 3, 41, 0, 2, 4, 43, 0, 44, 0, 55, 0, 56, 0, 55, 1, 46, 0, 62, 0, 24, 0, 0, 0, 62, 0, 49, 1, 62, 0, 48, 1, 55, 0, 68, 0, 68, 0, 69, 0, 70, 0, 22, 2, 49, 0, 71, 0, 71, 0, 22, 1, 48, 0, 72, 0, 72, 0, 22, 0, 62, 0, 74, 0, 74, 0, 75, 0, 69, 0, 62, 1, 76, 0, 72, 1, 76, 0, 71, 1, 80, 0, 79, 0, 80, 0, 79, 1, 79, 0, 81, 1, 82, 0, 81, 0, 83, 0, 77, 0, 84, 0, 77, 1, 85, 0, 77, 2, 77, 1, 0, 8, 77, 0, 0, 3, 81, 0, 83, 0)
